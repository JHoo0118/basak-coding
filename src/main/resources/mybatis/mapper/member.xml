<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.basakcoding.basak.mapper.MemberMapper">

	<!-- 테스트 -->
	<select id="selectListWithReview" resultType="map" >
		SELECT m.*, r.content, r.rating FROM members m JOIN review r ON m.member_id = r.member_id
	</select>

	<!-- 전체 사용자 얻기 -->
	<select id="selectList" resultType="MemberDTO" >
		SELECT * FROM members ORDER BY registered_at DESC
	</select>
	
	<!-- 아이디로 사용자 얻기 -->
	<select id="getMemberById" parameterType="String" resultType="MemberDTO">
		SELECT * FROM members WHERE member_id=#{memberId}
	</select>
	
	<!-- 이메일로 사용자 얻기 -->
	<select id="getMemberByEmail" parameterType="String" resultType="MemberDTO">
		SELECT * FROM members WHERE email=#{email}
	</select>
	
	<!-- 사용자 생성, selectKey로 memberId반환 -->
	<insert id="createMember" parameterType="Map">
		<selectKey keyProperty="memberId" resultType="int" order="BEFORE">
			SELECT seq_members.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO members VALUES(#{memberId}, #{email}, #{password}, #{username}, DEFAULT, DEFAULT, DEFAULT, 
		<choose>
			<when test="avatar != null">#{avatar},</when>
			<otherwise>DEFAULT,</otherwise>
		</choose>
		null)
	</insert>
	
	<!-- 사용자 수정 -->
	<update id="updateMember" parameterType="Map">
		UPDATE members SET username=#{username}
		<if test="avatar != null">, avatar=#{avatar}</if> 
		WHERE member_id=#{memberId}
	</update>
	
	<delete id="deleteMultpleMember" parameterType="Map">
		DELETE members WHERE member_id in
		<foreach collection="target" item="item" separator="," open="(" close=")">
			#{item}
		</foreach>
	</delete>
	
	<!-- 파일 업로드 -->
	<update id="fileUpdate" parameterType="Map">
		UPDATE MEMBERS SET AVATAR=#{file_name} WHERE MEMBER_ID=#{userId}
	</update>
	
	<!-- 프로필페이지 내정보 가져오기 -->
	<select id="selectMyInfo" parameterType="int" resultType="map">
		SELECT * FROM members WHERE member_id=#{userId}
	</select>
	
	<!-- 결제한 강의 개수가져오기 -->
	<select id="paymentCount" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM payment p JOIN members m ON (p.member_id =m.member_id) WHERE m.member_id=#{userId}
		AND p.payment_state='결제 완료'
	</select>
	
	<!-- 나의 댓글 개수-->
	<select id="commentsCount" parameterType="int" resultType="int">
		select count(*) from comments c JOIN members m ON (c.member_id = m.member_id) WHERE m.member_id=#{userId}
	</select>
	
	<!-- 나의 질문 개수-->
	<select id="questionCount" parameterType="int" resultType="int">
		select count(*) from question q JOIN members m ON (q.member_id = m.member_id) WHERE m.member_id=#{userId}
	</select>
	
	<!-- 나의 닉네임 변경 -->
	<update id="userNameEdit" parameterType="Map">
		UPDATE members SET username=#{username} WHERE member_id=#{userId}
	</update>
	
	
</mapper>