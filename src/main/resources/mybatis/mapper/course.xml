<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.basakcoding.basak.mapper.CourseMapper">
	<!-- 카테고리 리스트 가져오기 -->
	<select id="categoryList" resultType="CategoryDTO">
		SELECT * FROM category
	</select>

	<!-- 강의 리스트 가져오기 -->
	<select id="selectList" resultType="Map">
		SELECT ca.name CAT_NAME, co.course_id, co.title, co.short_description, a.name ADM_NAME 
		FROM courses co
		JOIN category ca ON ca.category_id = co.category_id
		JOIN admins a ON co.admin_id = a.admin_id
	</select>
	
	<!-- 강의 생성 후 강의 PK반환 -->
	<insert id="createCourse" parameterType="Map">
		<selectKey keyProperty="courseId" resultType="int" order="BEFORE">
			SELECT seq_courses.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO courses VALUES(#{courseId}, #{adminId}, #{categoryId}, #{courseTitle}, #{shortDescription}, 
		#{description}, #{price}, #{difficulty}, DEFAULT, #{thumbnail}, DEFAULT, DEFAULT, DEFAULT, DEFAULT, DEFAULT)
	</insert>
	
	<!-- FAQ 생성 -->
	<insert id="createFaq" parameterType="Map">
		INSERT INTO faq VALUES(seq_faq.NEXTVAL, #{courseId}, #{title}, #{content})
	</insert>
	
	<!-- 커리큘럼 생성 -->
	<insert id="createCurri" parameterType="Map">
		<selectKey keyProperty="curriculumId" resultType="int" order="BEFORE">
			SELECT seq_curriculum.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO curriculum VALUES(#{curriculumId}, #{courseId}, #{name})
	</insert>
	
	<!-- 비디오 생성 -->
	<insert id="createVideo" parameterType="Map">
		<selectKey keyProperty="videoId" resultType="int" order="BEFORE">
			SELECT seq_video.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO video VALUES(#{videoId}, #{curriculumId}, #{videoUri}, #{videoLength}, null, #{videoTitle}, #{videoContent})
	</insert>
	
	<!-- 파일 생성 -->
	<insert id="createFile" parameterType="Map">
		INSERT INTO files VALUES(seq_files.NEXTVAL, #{videoId}, #{fileName}, #{fileUri})
	</insert>
	
	<!-- 강의 비디오 총 개수 및 총 길이 업데이트 -->
	<update id="updateVideoCntAndLength" parameterType="map">
		UPDATE courses SET video_count = #{videoCnt}, course_length = #{totalVideoLength}  WHERE course_id = #{courseId}
	</update>
	
	<!-- 파일 목록 가져오기 -->
	<select id="getFileList" parameterType="String" resultType="Map">
		SELECT * FROM files WHERE video_id = #{videoId} 
	</select>
	
	<!-- resultMap용 파일 목록 가져오기 -->
	<select id="resultMapFileList" resultType="FileDTO">
		SELECT * FROM files WHERE video_id = #{videoMap} ORDER BY file_id
	</select>
	
	<!-- FAQ 목록 가져오기 -->
	<select id="getFAQList" parameterType="String" resultType="FAQDTO">
		SELECT * FROM faq WHERE course_id = #{courseId}
	</select>
	
	<!-- 비디오 아이디로 강의 아이디 가져오기 -->
	<select id="getCourseId" parameterType="String" resultType="String">
		SELECT cu.course_id FROM video v JOIN curriculum cu 
		ON v.curriculum_id = cu.curriculum_id WHERE v.video_id = #{videoId}
	</select>
	
	<!-- 비디오 얻기 -->
	<resultMap type="VideoDTO" id="videoMap">
		<collection column="video_id"
					property="files"
					javaType="java.util.List"
					ofType="FileDTO"
					select="resultMapFileList">
		</collection>
	</resultMap>
	<select id="getVideo" parameterType="String" resultType="VideoDTO">
		SELECT * FROM video WHERE video_id = #{videoId}
	</select>
	
	<resultMap type="CurriculumDTO" id="curriculums">
		<collection column="curriculum_id" 
                    property="videos" 
                    javaType="java.util.List" 
                    ofType="VideoDTO" 
                    select="getVideoList">
        </collection>
	</resultMap>
	
	<select id="alreadyPayment" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		FROM courses co
		JOIN payment pa ON pa.course_id = co.course_id
		JOIN category ca ON ca.category_id = co.category_id
		JOIN admins a ON co.admin_id = a.admin_id WHERE co.course_id = #{courseId} AND pa.member_id = #{memberId}
	</select>
	
	
	<!-- 커리큘럼 얻기 -->
	<select id="getCurriculumList" parameterType="String" resultMap="curriculums">
		SELECT * FROM curriculum WHERE course_id = #{courseId}
	</select>
	
    <select id="getVideoList" resultMap="videoMap">
       	SELECT * FROM video WHERE curriculum_id = #{curriculums} ORDER BY video_id
    </select>
    
    <select id="isSeen" parameterType="map" resultType="int">
    	SELECT COUNT(*) FROM videoMember WHERE 
    	video_id = #{videoId} AND member_id = #{memberId} AND seen = 'Y'
    </select>
	
	<!-- 강의 상세보기 -->
	<select id="getCourseOne" parameterType="Map" resultType="CourseDTO">
		SELECT course_id, ca.name categoryname, ad.name adminname, difficulty,
		price,thumbnail, title, short_description, description
		FROM courses c
		JOIN category ca ON ca.category_id = c.category_id
		JOIN admins ad ON ad.admin_id = c.admin_id
		WHERE course_id = #{no}
	</select>
</mapper>